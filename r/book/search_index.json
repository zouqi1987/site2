[
["index.html", "A Minimal Wiki Example Chapter 1 Prerequisites", " A Minimal Wiki Example Qi Zou 2018-03-14 Chapter 1 Prerequisites This is a sample book written in Markdown. You can use anything that Pandoc’s Markdown supports, e.g., a math equation \\(a^2 + b^2 = c^2\\). The bookdown package can be installed from CRAN or Github: install.packages(&quot;bookdown&quot;) # or the development version # devtools::install_github(&quot;rstudio/bookdown&quot;) Remember each Rmd file contains one and only one chapter, and a chapter is defined by the first-level heading #. To compile this example to PDF, you need XeLaTeX. You are recommended to install TinyTeX (which includes XeLaTeX): https://yihui.name/tinytex/. "],
["intro.html", "Chapter 2 Introduction", " Chapter 2 Introduction This is book serves as wiki while I’m working at Weibo.com. "],
["topspeed.html", "Chapter 3 Topspeed 3.1 极速版数据仓库 3.2 极速版数仓字典 3.3 极速版邮件调度 3.4 极速版FID 3.5 极速版action 3.6 极速版互动（转评赞）", " Chapter 3 Topspeed 3.1 极速版数据仓库 3.1.1 极速版打码日志 日志传输直接入库 表临时命名为: weibo_lite_ods1 3.1.2 极速版月活表(每日全量表) day=`date -d &quot;1 day ago&quot; +%Y%m%d` last_30day=`date -d &quot;30 days ago&quot; +%Y%m%d` dt_1=`date -d &quot;2 days ago&quot; +%Y%m%d` dt_30=`date -d &quot;31 days ago&quot; +%Y%m%d` ### 极速版月活表(每日全量表) 表临时命名为: elite_month_active SELECT t1.uid, t1.aid, t2.reg_time, CASE WHEN t3.uid IS NULL AND t4.uid IS NULL AND t1.actv_days = 30 THEN &#39;5&#39; WHEN t3.uid IS NULL AND t4.uid IS NULL AND t1.actv_days &gt;= 25 AND t1.actv_days &lt;= 29 THEN &#39;4&#39; WHEN t3.uid IS NULL AND t4.uid IS NULL AND t1.actv_days &gt;= 12 AND t1.actv_days &lt;= 24 THEN &#39;3&#39; WHEN t3.uid IS NULL AND t4.uid IS NULL AND t1.actv_days &gt;= 4 AND t1.actv_days &lt;= 11 THEN &#39;2&#39; WHEN t3.uid IS NULL AND t4.uid IS NULL AND t1.actv_days &gt;= 1 AND t1.actv_days &lt;= 3 THEN &#39;1&#39; ELSE &#39;9&#39; END AS actv_freq FROM (SELECT uid, aid, count(dt) AS actv_days FROM weibo_lite_ods1 WHERE dt BETWEEN &#39;${last_30day}&#39; AND &#39;${day}&#39; GROUP BY uid, aid) t1 LEFT JOIN (SELECT uid, aid, day_key AS reg_time FROM weibo_lite_ods1 WHERE dt BETWEEN &#39;${last_30day}&#39; AND &#39;${day}&#39; AND action = &#39;2358&#39;) t2 ON t1.uid = t2.uid LEFT JOIN (SELECT guest_id AS uid FROM elite_guest_login WHERE dt BETWEEN &#39;${last_30day}&#39; AND &#39;${day}&#39; AND MODE = &#39;register&#39;) t3 ON t1.uid = t3.uid LEFT JOIN (SELECT uid FROM elite_reg_info WHERE dt BETWEEN &#39;${last_30day}&#39; AND &#39;${day}&#39;) t4 ON t1.uid = t4.uid GROUP BY t1.uid, t1.aid, t2.reg_time, actv_freq 3.1.3 极速版访客登录表(每日全量表) 表临时命名为: elite_guest_login_all SELECT guest_id, aid, from_val, init_wm FROM (SELECT guest_id, aid, from_val, init_wm FROM elite_guest_login_all WHERE dt = &#39;${day}&#39; UNION ALL SELECT uid AS guest_id, aid, from_val, init_wm FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; AND length(uid) = 13 GROUP BY uid, aid, from_val, init_wm) t1 GROUP BY guest_id, aid, from_val, init_wm 3.1.4 极速版访客登录表(每日增量表) 表临时命名为: elite_guest_login SELECT uid AS guest_id, MODE, extend AS uid, aid, from_val, init_wm FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; AND length(uid) = 13 GROUP BY uid, MODE, extend, aid, from_val, init_wm 3.1.5 用户类型表（每天增量表） 表临时命名为: elite_user_type SELECT t2.label AS user_type, t1.uid, t1.aid, t1.from_val, t1.wm, t1.init_wm FROM (SELECT uid, aid, from_val, wm, init_wm FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39;) t1 LEFT JOIN (SELECT f.uid AS uid, f.gp AS label FROM (SELECT CASE WHEN d.uid IS NOT NULL THEN &#39;新户正式用户&#39; ELSE &#39;召回正式用户&#39; END AS gp, c.uid (SELECT a.uid FROM (SELECT uid FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; AND length(uid)&lt;=10 GROUP BY uid) a LEFT JOIN (SELECT uid FROM elite_month_active WHERE dt = &#39;${dt_1}&#39; AND length(uid) &lt;=10 GROUP BY uid) b ON a.uid = b.uid WHERE b.uid IS NULL) c LEFT JOIN (SELECT uid FROM elite_reg_info WHERE dt = &#39;day&#39; GROUP BY uid) d ON c.uid = d.uid UNION ALL SELECT CASE WHEN d1.uid IS NOT NULL THEN &#39;新户访客&#39; ELSE &#39;召回访客&#39; END AS gp, c1.uid FROM (SELECT a1.uid FROM (SELECT w.guest_id AS uid FROM (SELECT guest_id FROM elite_guest_login WHERE dt = &#39;${day}&#39;) w1 LEFT JOIN (SELECT guest_id FROM elite_guest_login WHERE dt = &#39;${day}&#39; AND MODE = &#39;TRANS&#39;) j1 ON w1.guest_id = j1.guest_id WHERE j1.guest_id IS NULL) a1 LEFT JOIN (SELECT guest_id AS uid FROM elite_guest_login WHERE dt BETWEEN &#39;${dt_30}&#39; AND &#39;${dt_1}&#39; GROUP BY guest_id) b1 ON a1.uid = b1.uid WHERE b1.uid IS NULL) c1 LEFT JOIN (SELECT guest_id AS uid FROM elite_guest_login WHERE dt = &#39;${day}&#39; AND MODE=&#39;REGISTER&#39; GROUP BY guest_id) d1 ON c1.uid = d1.uid) f GROUP BY f.gp, f.uid) t2 ON t1.uid = t2.uid 3.1.6 极速版用户注册信息表(每日增量表) 表临时命名为: elite_reg_info SELECT uid, aid, day_key AS reg_time FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; AND action = &#39;2358&#39; 3.1.7 建表信息 dbConnect(MySQL(), user = &quot;root&quot;, password = &quot;1qaz2wsxQWE&quot;, dbname = &quot;wbapp_ugda&quot;, port = 3306, host = &quot;10.77.39.132&quot;) | dip_topspeed | CREATE TABLE `dip_topspeed` ( `id` int(11) NOT NULL AUTO_INCREMENT, `dau` bigint(20) NOT NULL, `refresh_uv` bigint(20) NOT NULL, `switch_uv` bigint(20) NOT NULL, `refresh_pv` bigint(20) NOT NULL, `switch_pv` bigint(20) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8 ---dau select count(distinct uid) from weibo_lite_ods1 where dt = ${day} ---refresh_uv select count(distinct uid) from weibo_lite_ods1 where dt = ${day} and action = &#39;2353&#39; ---refresh_pv select count(uid) from weibo_lite_ods1 where dt = ${day} and action = &#39;2353&#39; ---switch_uv select count(distinct uid) from weibo_lite_ods1 where dt = ${day} and action = &#39;2321&#39; ---switch_pv select count(uid) from weibo_lite_ods1 where dt = ${day} and action = &#39;2321&#39; 3.2 极速版数仓字典 3.2.1 极速版打码日志(每日增量表) 表名：weibo_lite_ods1 字段名 字段描述 数据类型 数据实例 说明 day_key 时间 string 23:00:00 行为发生时间 uid UID string 1281231231 13位为访客10位为正式用户 aid 设备aid string action 行为码 string 97 uicode 页面uicode string 10000011 luicode 上级页面uidcode string 10000011 wm wm值 string 4209_8001 oldwm 初始wm值 string 4209_8002 extend 扩展字段 string fid string lfid string from_val from值 string 1041095010 dt 时间 string 20131-11-08 3.2.2 极速版用户注册信息表(每日增量表) 表名：weibo_lite_reg_info 字段名 字段描述 数据类型 数据实例 说明 uid 用户uid String 10000011 有行为码2358的用户 aid 设备aid String 01AlwhaY0yxNx4TuiTIw2jweTC-OVGqSjZLjWr4qiOQrwZMRM. reg_time 注册时间 String 41643.95833 dt 时间 20131118 3.3 极速版邮件调度 #!/bin/sh day=`date -d &quot;1 day ago&quot; +%Y%m%d` last_1=`date -d &quot;${day} 1 days ago&quot; +%Y%m%d` hive -e&quot; ## 新增安装量和留存 SELECT oldwm, count(t1.aid) AS newdevice_cnt, count(t2.aid) AS tmr_retent_cnt, &#39;${day}&#39; FROM (SELECT a.aid, a.oldwm FROM (SELECT aid, oldwm FROM weibo_lite_ods1 WHERE dt = &#39;${last_1}&#39; GROUP BY aid, oldwm) a LEFT JOIN (SELECT aid FROM weibo_lite_ods1 WHERE dt &lt; &#39;${last_1}&#39; GROUP BY aid) b ON a.aid = b.aid WHERE b.aid IS NULL) t1 LEFT JOIN (SELECT aid FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; GROUP BY aid) t2 ON t1.aid = t2.aid GROUP BY oldwm ## feed 刷新次数/人数 SELECT count(uid) AS refresh_pv, count(distinct uid) AS refresh_uv, TYPE, &#39;${day}&#39; FROM (SELECT uid, CASE WHEN ((fid LIKE &#39;10001%&#39; OR fid LIKE &#39;10009%&#39; OR fid LIKE &#39;10010%&#39; OR fid LIKE &#39;10013%&#39; OR fid = &#39;friend_timeline&#39;) AND uicode = &#39;10000613&#39;) THEN &#39;guanzhu&#39; WHEN fid IN (&#39;102803&#39;, &#39;same_city&#39;, &#39;102803_ctg1_7968_-_ctg1_7968&#39;, &#39;102803_ctg1_4388_-_ctg1_4388&#39;, &#39;102803_ctg1_1988_-_ctg1_1988&#39;, &#39;102803_ctg1_4288_-_ctg1_4288&#39;, &#39;102803_ctg1_4188_-_ctg1_4188&#39;, &#39;102803_ctg1_5088_-_ctg1_5088&#39;, &#39;102803_ctg1_1388_-_ctg1_1388&#39;, &#39;102803_ctg1_2288_-_ctg1_2288&#39;, &#39;102803_ctg1_5188_-_ctg1_5188&#39;, &#39;102803_ctg1_3288_-_ctg1_3288&#39;, &#39;102803_ctg1_4888_-_ctg1_4888&#39;, &#39;102803_ctg1_6288_-_ctg1_6288&#39;, &#39;102803_ctg1_2088_-_ctg1_2088&#39;, &#39;102803_ctg1_1288_-_ctg1_1288&#39;, &#39;102803_ctg1_5288_-_ctg1_5288&#39;, &#39;102803_ctg1_2388_-_ctg1_2388&#39;, &#39;102803_ctg1_6688_-_ctg1_6688&#39;, &#39;102803_ctg1_6388_-_ctg1_6388&#39;, &#39;102803_ctg1_6788_-_ctg1_6788&#39;, &#39;102803_ctg1_2688_-_ctg1_2688&#39;, &#39;102803_ctg1_4988_-_ctg1_4988&#39;, &#39;102803_ctg1_2488_-_ctg1_2488&#39;, &#39;102803_ctg1_4588_-_ctg1_4588&#39;, &#39;102803_ctg1_1488_-_ctg1_1488&#39;, &#39;102803_ctg1_5988_-_ctg1_5988&#39;, &#39;102803_ctg1_4788_-_ctg1_4788&#39;, &#39;102803_ctg1_4688_-_ctg1_4688&#39;, &#39;102803_ctg1_1588_-_ctg1_1588&#39;, &#39;102803_ctg1_2788_-_ctg1_2788&#39;, &#39;102803_ctg1_4488_-_ctg1_4488&#39;, &#39;102803_ctg1_7388_-_ctg1_7388&#39;, &#39;102803_ctg1_7088_-_ctg1_7088&#39;, &#39;102803_ctg1_5388_-_ctg1_5388&#39;, &#39;102803_ctg1_2588_-_ctg1_2588&#39;, &#39;102803_ctg1_5488_-_ctg1_5488&#39;, &#39;102803_ctg1_1688_-_ctg1_1688&#39;, &#39;102803_ctg1_5888_-_ctg1_5888&#39;, &#39;102803_ctg1_5588_-_ctg1_5588&#39;, &#39;102803_ctg1_6488_-_ctg1_6488&#39;, &#39;102803_ctg1_2188_-_ctg1_2188&#39;, &#39;102803_ctg1_6588_-_ctg1_6588&#39;, &#39;102803_ctg1_5688_-_ctg1_5688&#39;, &#39;102803_ctg1_6988_-_ctg1_6988&#39;, &#39;102803_ctg1_5788_-_ctg1_5788&#39;, &#39;102803_ctg1_3188_-_ctg1_3188&#39;, &#39;102803_ctg1_8788_-_ctg1_8788&#39;, &#39;102803_ctg1_8189_-_ctg1_8189&#39;, &#39;102803_ctg1_1788_-_ctg1_1788&#39;, &#39;102803_ctg1_7188_-_ctg1_7188&#39;, &#39;102803_ctg1_8999_-_ctg1_8999_home&#39;, &#39;102803_ctg1_8998_-_ctg1_8998&#39;, &#39;102803_ctg1_8997_-_ctg1_8997&#39;, &#39;102803_ctg1_9999_-_ctg1_9999&#39;, &#39;102803_ctg1_8899_-_ctg1_8899&#39;, &#39;102803_ctg1_8799_-_ctg1_8799&#39;, &#39;102803_ctg1_8698_-_ctg1_8698&#39;) THEN &#39;remen&#39; WHEN fid IN (&#39;231159&#39;, &#39;231159_video_tag_1&#39;, &#39;231159_video_tag_2&#39;, &#39;231159_video_tag_14&#39;, &#39;231159_video_tag_15&#39;, &#39;231159_video_tag_3&#39;, &#39;231159_video_tag_4&#39;, &#39;231159_video_tag_5&#39;, &#39;231159_video_tag_7&#39;, &#39;231159_video_tag_8&#39;, &#39;231159_video_tag_16&#39;) THEN &#39;shipin&#39; ELSE NULL END AS TYPE FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; AND action = &#39;2353&#39;)t1 GROUP BY TYPE ## 频道top 5 SELECT cnt, fid, TYPE, &#39;${day}&#39; FROM (SELECT cnt, fid, TYPE, row_number() over (partition by TYPE order by cnt desc) as rn FROM (SELECT count(1) as cnt, fid, TYPE FROM (SELECT uid, fid, CASE WHEN ((fid LIKE &#39;10001%&#39; OR fid LIKE &#39;10009%&#39; OR fid LIKE &#39;10010%&#39; OR fid LIKE &#39;10013%&#39; OR fid = &#39;friend_timeline&#39;) AND uicode = &#39;10000613&#39;) THEN &#39;guanzhu&#39; WHEN fid IN (&#39;102803&#39;, &#39;same_city&#39;, &#39;102803_ctg1_7968_-_ctg1_7968&#39;, &#39;102803_ctg1_4388_-_ctg1_4388&#39;, &#39;102803_ctg1_1988_-_ctg1_1988&#39;, &#39;102803_ctg1_4288_-_ctg1_4288&#39;, &#39;102803_ctg1_4188_-_ctg1_4188&#39;, &#39;102803_ctg1_5088_-_ctg1_5088&#39;, &#39;102803_ctg1_1388_-_ctg1_1388&#39;, &#39;102803_ctg1_2288_-_ctg1_2288&#39;, &#39;102803_ctg1_5188_-_ctg1_5188&#39;, &#39;102803_ctg1_3288_-_ctg1_3288&#39;, &#39;102803_ctg1_4888_-_ctg1_4888&#39;, &#39;102803_ctg1_6288_-_ctg1_6288&#39;, &#39;102803_ctg1_2088_-_ctg1_2088&#39;, &#39;102803_ctg1_1288_-_ctg1_1288&#39;, &#39;102803_ctg1_5288_-_ctg1_5288&#39;, &#39;102803_ctg1_2388_-_ctg1_2388&#39;, &#39;102803_ctg1_6688_-_ctg1_6688&#39;, &#39;102803_ctg1_6388_-_ctg1_6388&#39;, &#39;102803_ctg1_6788_-_ctg1_6788&#39;, &#39;102803_ctg1_2688_-_ctg1_2688&#39;, &#39;102803_ctg1_4988_-_ctg1_4988&#39;, &#39;102803_ctg1_2488_-_ctg1_2488&#39;, &#39;102803_ctg1_4588_-_ctg1_4588&#39;, &#39;102803_ctg1_1488_-_ctg1_1488&#39;, &#39;102803_ctg1_5988_-_ctg1_5988&#39;, &#39;102803_ctg1_4788_-_ctg1_4788&#39;, &#39;102803_ctg1_4688_-_ctg1_4688&#39;, &#39;102803_ctg1_1588_-_ctg1_1588&#39;, &#39;102803_ctg1_2788_-_ctg1_2788&#39;, &#39;102803_ctg1_4488_-_ctg1_4488&#39;, &#39;102803_ctg1_7388_-_ctg1_7388&#39;, &#39;102803_ctg1_7088_-_ctg1_7088&#39;, &#39;102803_ctg1_5388_-_ctg1_5388&#39;, &#39;102803_ctg1_2588_-_ctg1_2588&#39;, &#39;102803_ctg1_5488_-_ctg1_5488&#39;, &#39;102803_ctg1_1688_-_ctg1_1688&#39;, &#39;102803_ctg1_5888_-_ctg1_5888&#39;, &#39;102803_ctg1_5588_-_ctg1_5588&#39;, &#39;102803_ctg1_6488_-_ctg1_6488&#39;, &#39;102803_ctg1_2188_-_ctg1_2188&#39;, &#39;102803_ctg1_6588_-_ctg1_6588&#39;, &#39;102803_ctg1_5688_-_ctg1_5688&#39;, &#39;102803_ctg1_6988_-_ctg1_6988&#39;, &#39;102803_ctg1_5788_-_ctg1_5788&#39;, &#39;102803_ctg1_3188_-_ctg1_3188&#39;, &#39;102803_ctg1_8788_-_ctg1_8788&#39;, &#39;102803_ctg1_8189_-_ctg1_8189&#39;, &#39;102803_ctg1_1788_-_ctg1_1788&#39;, &#39;102803_ctg1_7188_-_ctg1_7188&#39;, &#39;102803_ctg1_8999_-_ctg1_8999_home&#39;, &#39;102803_ctg1_8998_-_ctg1_8998&#39;, &#39;102803_ctg1_8997_-_ctg1_8997&#39;, &#39;102803_ctg1_9999_-_ctg1_9999&#39;, &#39;102803_ctg1_8899_-_ctg1_8899&#39;, &#39;102803_ctg1_8799_-_ctg1_8799&#39;, &#39;102803_ctg1_8698_-_ctg1_8698&#39;) THEN &#39;remen&#39; WHEN fid IN (&#39;231159&#39;, &#39;231159_video_tag_1&#39;, &#39;231159_video_tag_2&#39;, &#39;231159_video_tag_14&#39;, &#39;231159_video_tag_15&#39;, &#39;231159_video_tag_3&#39;, &#39;231159_video_tag_4&#39;, &#39;231159_video_tag_5&#39;, &#39;231159_video_tag_7&#39;, &#39;231159_video_tag_8&#39;, &#39;231159_video_tag_16&#39;) THEN &#39;shipin&#39; ELSE NULL END AS TYPE FROM weibo_lite_ods1 WHERE dt = &#39;${day}&#39; AND action = &#39;2353&#39;)t1 GROUP BY fid, TYPE)t2)t3 WHERE rn &lt;= 5 &quot; 3.4 极速版FID 3.4.1 关注 频道 containerid 全部关注 10001 好友圈（互相关注） 10009 群微博 10010 V+微博 10013 时间序 friend_timeline 3.4.2 热门 频道 containerid 附近 same_city 热门 102803 新时代 102803_ctg1_7968_-_ctg1_7968 搞笑 102803_ctg1_4388_-_ctg1_4388 情感 102803_ctg1_1988_-_ctg1_1988 明星 102803_ctg1_4288_-_ctg1_4288 社会 102803_ctg1_4188_-_ctg1_4188 数码 102803_ctg1_5088_-_ctg1_5088 体育 102803_ctg1_1388_-_ctg1_1388 美女模特 102803_ctg1_2288_-_ctg1_2288 汽车 102803_ctg1_5188_-_ctg1_5188 电影 102803_ctg1_3288_-_ctg1_3288 游戏 102803_ctg1_4888_-_ctg1_4888 国际 102803_ctg1_6288_-_ctg1_6288 科技 102803_ctg1_2088_-_ctg1_2088 股市 102803_ctg1_1288_-_ctg1_1288 音乐 102803_ctg1_5288_-_ctg1_5288 动漫 102803_ctg1_2388_-_ctg1_2388 军事 102803_ctg1_6688_-_ctg1_6688 财经 102803_ctg1_6388_-_ctg1_6388 历史 102803_ctg1_6788_-_ctg1_6788 美食 102803_ctg1_2688_-_ctg1_2688 美图 102803_ctg1_4988_-_ctg1_4988 电视剧 102803_ctg1_2488_-_ctg1_2488 读书 102803_ctg1_4588_-_ctg1_4588 校园 102803_ctg1_1488_-_ctg1_1488 科普 102803_ctg1_5988_-_ctg1_5988 运动健身 102803_ctg1_4788_-_ctg1_4788 综艺 102803_ctg1_4688_-_ctg1_4688 美妆 102803_ctg1_1588_-_ctg1_1588 萌宠 102803_ctg1_2788_-_ctg1_2788 时尚 102803_ctg1_4488_-_ctg1_4488 法律 102803_ctg1_7388_-_ctg1_7388 正能量 102803_ctg1_7088_-_ctg1_7088 设计 102803_ctg1_5388_-_ctg1_5388 旅游 102803_ctg1_2588_-_ctg1_2588 艺术 102803_ctg1_5488_-_ctg1_5488 星座 102803_ctg1_1688_-_ctg1_1688 家居 102803_ctg1_5888_-_ctg1_5888 房产 102803_ctg1_5588_-_ctg1_5588 瘦身 102803_ctg1_6488_-_ctg1_6488 健康 102803_ctg1_2188_-_ctg1_2188 养生 102803_ctg1_6588_-_ctg1_6588 宗教 102803_ctg1_5688_-_ctg1_5688 辟谣 102803_ctg1_6988_-_ctg1_6988 政务 102803_ctg1_5788_-_ctg1_5788 育儿 102803_ctg1_3188_-_ctg1_3188 舞蹈 102803_ctg1_8788_-_ctg1_8788 收藏 102803_ctg1_8189_-_ctg1_8189 婚庆 102803_ctg1_1788_-_ctg1_1788 三农 102803_ctg1_7188_-_ctg1_7188 24小时榜 102803_ctg1_8999_-_ctg1_8999_home 男榜 102803_ctg1_8998_-_ctg1_8998 女榜 102803_ctg1_8997_-_ctg1_8997 小时榜 102803_ctg1_9999_-_ctg1_9999 昨日 102803_ctg1_8899_-_ctg1_8899 前日 102803_ctg1_8799_-_ctg1_8799 周榜 102803_ctg1_8698_-_ctg1_8698 3.4.3 视频 频道 containerid 热门 231159 搞笑 231159_video_tag_1 音乐 231159_video_tag_2 时尚美妆 231159_video_tag_14 美食 231159_video_tag_15 萌娃萌宠 231159_video_tag_3 明星综艺 231159_video_tag_4 微天下 231159_video_tag_5 影视 231159_video_tag_7 体育健身 231159_video_tag_8 旅游 231159_video_tag_16 3.4.4 页面 具体页面再用container_id区分： 1. 极速版的关注流、热门流、附近流、小视频是同一个页面，故都采用uicode=10000613 2. 所有正文页：uicode=10000617 3. 搜索页：uicode=10000620 4. 访客流多信息流：uicode=10000660 5. 公共的channel页面（找人 话题 榜单）：uicode=10000661 3.5 极速版action 行为名 行为code 行为简介 前后台 2036-点击注册按钮 2036 点击注册按钮，在热门流、附近页、周边页中，通过uicode区分-from 彭婷-20170830 前台 2051-关注流-点击个人中心 2051 关注流-点击个人中心-from 彭婷-20170830 前台 2052-关注流-点击消息箱 2052 关注流-点击消息箱-from 彭婷-20170830 前台 2053-关注流-点击搜索框 2053 关注流-点击搜索框-from 彭婷-20170830 前台 2056-点击评论 2056 点击评论，在关注流、热门流、附近页、周边页、评论盖楼页（评论右下方评论按钮）、搜索结果综合页、客人态中都有，通过uicode区分-from 彭婷-20170830 前台 2057-点击分享 2057 点击分享（与转评赞并列的分享按钮），在关注流、热门流、附近页、周边页、正文页、搜索结果综合页、客人态中都有，通过uicode区分-from 彭婷-20170830 前台 2058-关注流-点击悬浮发布器 2058 关注流-点击悬浮发布器-from 彭婷-20170830 前台 2059-点击流内用户头像 2059 点击流内用户头像，在关注流、正文页、搜索结果综合页、搜索结果用户页、通知页都有，通过uicode区分-from 彭婷-20170830 前台 2063-点击登录按钮 2063 点击登录按钮，在热门流、附近页、周边页中，通过uicode区分-from 彭婷-20170830 前台 2321-极速版客户端前后台切换行为码 2321 极速版客户端前后台切换行为码 前台/后台 2112-视频播放 2112 视频播放行为，在关注流、热门流、附近页、周边页、搜索结果综合页、主人态、客人态中都有，通过uicode区分-from 彭婷-20170904 前台 2113-点击图片 2113 点击图片，在关注流、热门流、附近页、周边页、正文页、评论盖楼页、搜索结果综合页、主人态、客人态中都有，通过uicode区分-from 彭婷-20170904 前台 点击底tab微博 2243 前台 点击底tab发现 2244 前台 点击底tab视频 2245 前台 点击底tab消息 2246 前台 邀请好友曝光 2256 前台 点击邀请好友 2257 前台 2112-视频播放 2112 2180-访客态顶导TAB横滑 2180 2358-注册成功 2358 ext : 1）reg_type，表示注册方式，=qq（qq注册），=weixin（微信注册），=phone（手机号注册） 2054-点击博文 2054 2078-点击分享至微信 2078 2079-点击分享至微信朋友圈 2079 2080-点击分享至QQ 2080 2081-点击分享至QQ空间 2081 2039-正文页-点击右上角“更多” 2039 2040-点击博文的转发列表 2040 2041-点击博文的评论列表 2041 2042-点击博文收获的赞列表 2042 搜索环节-点击搜索框 2071 2072-搜索页-点击微博热搜榜 2072 2073-搜索页-点击热搜索具体排行 2073 2076-搜索结果用户页-点击综合按钮 2076 2082-通知页-点击返回 2082 2085-profile-点击返回 2085 2050-发布器页-点击返回 2050 搜索环节-点击返回 2070 刷新行为 2353 “在关注流、热门流、视频流、附近页、搜索结果页、profile都有，通过uicode区分-from 彭婷-20180104.ext: 1）is_act，表示用户刷新流操作，=0（被动刷新）、=1（主动刷新）；2）load_type，表示刷feed方式，=pull（上拉刷新），=load_more（后向加载）” 3.6 极速版互动（转评赞） SELECT count(a.uid), a.fid FROM ( SELECT uid, split(split(extend, &#39;containerid:&#39;)[1], &#39;\\\\;&#39;)[0] AS fid FROM mds_bhv_pubblog WHERE dt =&#39;${day[$i]}&#39; AND is_transmit=&#39;1&#39; AND split(split(extend, &#39;containerid:&#39;)[1], &#39;\\\\;&#39;)[0] IN (&#39;901802&#39;, &#39;901802_attention_tag_1&#39;, &#39;901802_attention_tag_2&#39;, &#39;901802_attention_tag_3&#39;, &#39;901802_attention_tag_4&#39;, &#39;901802_attention_tag_5&#39;, &#39;901802_attention_tag_15&#39;, &#39;901802_attention_tag_16&#39;, &#39;901802_attention_tag_17&#39;, &#39;901802_attention_tag_18&#39;, &#39;901802_attention_tag_19&#39;, &#39;901802_attention_tag_20&#39;, &#39;102803&#39;, &#39;2311460031&#39;, &#39;2312610001&#39;, &#39;102803_ctg1_4388_-_ctg1_4388&#39;, &#39;102803_ctg1_1988_-_ctg1_1988&#39;, &#39;102803_ctg1_4288_-_ctg1_4288&#39;, &#39;102803_ctg1_4188_-_ctg1_4188&#39;, &#39;102803_ctg1_5088_-_ctg1_5088&#39;, &#39;102803_ctg1_1388_-_ctg1_1388&#39;, &#39;102803_ctg1_2288_-_ctg1_2288&#39;, &#39;102803_ctg1_5188_-_ctg1_5188&#39;, &#39;102803_ctg1_3288_-_ctg1_3288&#39;, &#39;102803_ctg1_4888_-_ctg1_4888&#39;, &#39;231159&#39;, &#39;231159_video_tag_1&#39;, &#39;231159_video_tag_2&#39;, &#39;231159_video_tag_14&#39;, &#39;231159_video_tag_15&#39;, &#39;231159_video_tag_3&#39;, &#39;231159_video_tag_4&#39;, &#39;231159_video_tag_5&#39;, &#39;231159_video_tag_7&#39;, &#39;231159_video_tag_8&#39;, &#39;231159_video_tag_16&#39;) AND split(split(extend, &#39;from:&#39;)[1], &#39;\\\\;&#39;)[0] LIKE &#39;25%&#39; UNION ALL SELECT uid, split(split(extend, &#39;fid:&#39;)[1], &#39;\\\\;&#39;)[0] AS fid FROM mds_bhv_like WHERE dt =&#39;${day[$i]}&#39; AND MODE=&#39;1&#39; AND split(split(extend, &#39;fid:&#39;)[1], &#39;\\\\;&#39;)[0] IN (&#39;901802&#39;, &#39;901802_attention_tag_1&#39;, &#39;901802_attention_tag_2&#39;, &#39;901802_attention_tag_3&#39;, &#39;901802_attention_tag_4&#39;, &#39;901802_attention_tag_5&#39;, &#39;901802_attention_tag_15&#39;, &#39;901802_attention_tag_16&#39;, &#39;901802_attention_tag_17&#39;, &#39;901802_attention_tag_18&#39;, &#39;901802_attention_tag_19&#39;, &#39;901802_attention_tag_20&#39;, &#39;102803&#39;, &#39;2311460031&#39;, &#39;2312610001&#39;, &#39;102803_ctg1_4388_-_ctg1_4388&#39;, &#39;102803_ctg1_1988_-_ctg1_1988&#39;, &#39;102803_ctg1_4288_-_ctg1_4288&#39;, &#39;102803_ctg1_4188_-_ctg1_4188&#39;, &#39;102803_ctg1_5088_-_ctg1_5088&#39;, &#39;102803_ctg1_1388_-_ctg1_1388&#39;, &#39;102803_ctg1_2288_-_ctg1_2288&#39;, &#39;102803_ctg1_5188_-_ctg1_5188&#39;, &#39;102803_ctg1_3288_-_ctg1_3288&#39;, &#39;102803_ctg1_4888_-_ctg1_4888&#39;, &#39;231159&#39;, &#39;231159_video_tag_1&#39;, &#39;231159_video_tag_2&#39;, &#39;231159_video_tag_14&#39;, &#39;231159_video_tag_15&#39;, &#39;231159_video_tag_3&#39;, &#39;231159_video_tag_4&#39;, &#39;231159_video_tag_5&#39;, &#39;231159_video_tag_7&#39;, &#39;231159_video_tag_8&#39;, &#39;231159_video_tag_16&#39;) AND split(split(extend, &#39;from:&#39;)[1], &#39;\\\\;&#39;)[0] LIKE &#39;25%&#39; UNION ALL SELECT uid, split(split(extend, &#39;fid:&#39;)[1], &#39;\\\\;&#39;)[0] AS fid FROM mds_bhv_cmtblog WHERE dt =&#39;${day[$i]}&#39; AND split(split(extend, &#39;fid:&#39;)[1], &#39;\\\\;&#39;)[0] IN (&#39;901802&#39;, &#39;901802_attention_tag_1&#39;, &#39;901802_attention_tag_2&#39;, &#39;901802_attention_tag_3&#39;, &#39;901802_attention_tag_4&#39;, &#39;901802_attention_tag_5&#39;, &#39;901802_attention_tag_15&#39;, &#39;901802_attention_tag_16&#39;, &#39;901802_attention_tag_17&#39;, &#39;901802_attention_tag_18&#39;, &#39;901802_attention_tag_19&#39;, &#39;901802_attention_tag_20&#39;, &#39;102803&#39;, &#39;2311460031&#39;, &#39;2312610001&#39;, &#39;102803_ctg1_4388_-_ctg1_4388&#39;, &#39;102803_ctg1_1988_-_ctg1_1988&#39;, &#39;102803_ctg1_4288_-_ctg1_4288&#39;, &#39;102803_ctg1_4188_-_ctg1_4188&#39;, &#39;102803_ctg1_5088_-_ctg1_5088&#39;, &#39;102803_ctg1_1388_-_ctg1_1388&#39;, &#39;102803_ctg1_2288_-_ctg1_2288&#39;, &#39;102803_ctg1_5188_-_ctg1_5188&#39;, &#39;102803_ctg1_3288_-_ctg1_3288&#39;, &#39;102803_ctg1_4888_-_ctg1_4888&#39;, &#39;231159&#39;, &#39;231159_video_tag_1&#39;, &#39;231159_video_tag_2&#39;, &#39;231159_video_tag_14&#39;, &#39;231159_video_tag_15&#39;, &#39;231159_video_tag_3&#39;, &#39;231159_video_tag_4&#39;, &#39;231159_video_tag_5&#39;, &#39;231159_video_tag_7&#39;, &#39;231159_video_tag_8&#39;, &#39;231159_video_tag_16&#39;) AND split(split(extend, &#39;from:&#39;)[1], &#39;\\\\;&#39;)[0] LIKE &#39;25%&#39;) a GROUP BY a.fid "],
["freq-sql.html", "Chapter 4 Freq Sql 4.1 push下发条数 4.2 DAU 4.3 点击数 4.4 首次打开按luicode 4.5 在线时长 4.6 可push库地理位置 4.7 用户类型 4.8 发博转发评论中位数 4.9 主要行为 4.10 曝光 4.11 点赞分享中位数", " Chapter 4 Freq Sql 4.1 push下发条数 SELECT count(t2.uid) FROM (SELECT uid FROM ods_wls_pushable_devicelist WHERE dt = &#39;20171214&#39; AND device_type = &#39;4&#39; AND chnl_brand IN (&#39;110&#39;, &#39;111&#39;) GROUP BY uid) t2 LEFT JOIN ( SELECT uid, luicode FROM (SELECT luicode, sid FROM ods_wls_push_ug_edm_content WHERE dt = &#39;20171214&#39;)b INNER JOIN (SELECT ltype AS sid , uid FROM ods_wls_push_ug_edm_send WHERE dt =&#39;20171214&#39;)c ON b.sid = c.sid UNION ALL SELECT uid, luicode FROM (SELECT uid, sid FROM ods_wls_push_op_send WHERE dt =&#39;20171214&#39;)b INNER JOIN (SELECT uicode AS luicode, sid FROM ods_wls_push_content WHERE dt =&#39;20171214&#39;)c ON b.sid = c.sid) t3 ON t2.uid=t3.uid WHERE t3.uid is not null 4.2 DAU 4.2.1 DAU SELECT count(a.uid) FROM (select w1.guest_id as uid from (select guest_id from ods_wls_guest_login where dt=&#39;20171205&#39; and wfrom like &#39;10%&#39; and ((wm&lt;&gt;&#39;8605_2003&#39; and wm&lt;&gt;&#39;4209_8001&#39; and wm&lt;&gt;&#39;90027_90052&#39;) or wm is null) group by guest_id )w1 left outer join (select guest_id from ods_wls_guest_login where dt=&#39;20171205&#39; and wfrom like &#39;10%&#39; and ((wm&lt;&gt;&#39;8605_2003&#39; and wm&lt;&gt;&#39;4209_8001&#39; and wm&lt;&gt;&#39;90027_90052&#39;) or wm is null) and mode=&#39;TRANS&#39; group by guest_id )j1 on w1.guest_id=j1.guest_id where j1.guest_id is null UNION ALL SELECT uid FROM mds_bhv_login_day WHERE dt=&#39;20171205&#39; AND login_type=&#39;wap_client&#39; AND length(uid)&lt;=10 GROUP BY uid) a 4.2.2 Dau 补全脚本 #!/bin/sh dt=&#39;20171101&#39; end=&#39;20180122&#39; part=`hive -e &quot;show partitions tmp_ug_main_dau partition(dt=&#39;${dt}&#39;)&quot;` while (( ${dt} &lt; ${end} )) do if [ -z ${part} ] then #statements hive -e&quot; insert overwrite table tmp_ug_main_dau partition(dt=&#39;${dt}&#39;) SELECT count(a.uid) FROM (SELECT w1.guest_id AS uid FROM (SELECT guest_id FROM ods_wls_guest_login WHERE dt=&#39;${dt}&#39; AND wfrom LIKE &#39;10%&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) GROUP BY guest_id )w1 LEFT OUTER JOIN (SELECT guest_id FROM ods_wls_guest_login WHERE dt=&#39;${dt}&#39; AND wfrom LIKE &#39;10%&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) AND MODE=&#39;TRANS&#39; GROUP BY guest_id )j1 ON w1.guest_id=j1.guest_id WHERE j1.guest_id IS NULL UNION ALL SELECT uid FROM mds_bhv_login_day WHERE dt=&#39;${dt}&#39; AND login_type=&#39;wap_client&#39; AND length(uid)&lt;=10 GROUP BY uid) a &quot; fi dt=`date -d &quot;${dt} +1 day&quot; +%Y%m%d` part=`hive -e &quot;show partitions tmp_ug_main_dau partition(dt=&#39;${dt}&#39;)&quot;` done 4.3 点击数 4.3.1 主feed的互动数 SELECT x.dt, count(1) AS hdl FROM (SELECT dt, uid, oper_src_id, opp_uid AS bdid FROM mds_bhv_pubblog WHERE dt=&#39;{dt}&#39; AND is_transmit=&#39;1&#39; AND (extend LIKE &#39;%loc:v6_content_home%&#39; OR extend LIKE &#39;%loc:home%&#39; OR extend LIKE &#39;%fromlog:10000%&#39; OR extend LIKE &#39;%fromlog:10001%&#39;) UNION ALL SELECT dt, uid, oper_src_id, object_owner AS bdid FROM mds_bhv_like WHERE dt=&#39;{dt}&#39; AND MODE=&#39;1&#39; AND object_type=&#39;status&#39; AND (extend LIKE &#39;%loc:v6_content_home%&#39; OR extend LIKE &#39;%loc:home%&#39; OR extend LIKE &#39;%fromlog:10000%&#39; OR extend LIKE &#39;%fromlog:10001%&#39;) UNION ALL SELECT dt, uid, oper_src_id, author_uid AS bdid FROM mds_bhv_cmtblog WHERE dt=&#39;{dt}&#39; AND (extend LIKE &#39;%loc:v6_content_home%&#39; OR extend LIKE &#39;%loc:home%&#39; OR extend LIKE &#39;%fromlog:10000%&#39; OR extend LIKE &#39;%fromlog:10001%&#39;)) x JOIN (SELECT appid FROM ods_dim_appkey WHERE dt=&#39;{dt}&#39; AND is_weibo=&#39;1&#39;) y ON x.oper_src_id=y.appid JOIN (SELECT dt, uid FROM mds_user_active_day_clear WHERE dt=&#39;{dt}&#39;) z ON x.uid=z.uid AND x.dt=z.dt GROUP BY x.dt 4.3.2 热门微博的互动数 SELECT x.uid, count(1) AS hdl FROM (SELECT dt, uid, oper_src_id, opp_uid AS bdid FROM mds_bhv_pubblog WHERE dt=&#39;{dt}&#39; AND is_transmit=&#39;1&#39; AND (extend LIKE &#39;%page_102803%&#39; OR extend LIKE &#39;%page_230509%&#39; OR extend LIKE &#39;%page_231159%&#39; OR (substr(split(findid(extend,&#39;spr&#39;),&#39;lfid:&#39;)[1],1,6) in(&#39;102803&#39;,&#39;230509&#39;,&#39;231159&#39;,&#39;230584&#39;,&#39;230781&#39;,&#39;231146&#39;,&#39;231147&#39;))) UNION ALL SELECT dt, uid, oper_src_id, object_owner AS bdid FROM mds_bhv_like WHERE dt=&#39;{dt}&#39; AND MODE=&#39;1&#39; AND object_type=&#39;status&#39; AND (extend LIKE &#39;%page_102803%&#39; OR extend LIKE &#39;%page_230509%&#39; OR extend LIKE &#39;%page_231159%&#39; OR (substr(split(findid(extend,&#39;spr&#39;),&#39;\\\\;fid:&#39;)[1],1,6) in(&#39;102803&#39;,&#39;230509&#39;,&#39;231159&#39;,&#39;230584&#39;,&#39;230781&#39;,&#39;231146&#39;,&#39;231147&#39;))) UNION ALL SELECT dt, uid, oper_src_id, author_uid AS bdid FROM mds_bhv_cmtblog WHERE dt=&#39;{dt}&#39; AND (extend LIKE &#39;%page_102803%&#39; OR extend LIKE &#39;%page_230509%&#39; OR extend LIKE &#39;%page_231159%&#39; OR (substr(split(findid(extend,&#39;spr&#39;),&#39;lfid:&#39;)[1],1,6) in(&#39;102803&#39;,&#39;230509&#39;,&#39;231159&#39;,&#39;230584&#39;,&#39;230781&#39;,&#39;231146&#39;,&#39;231147&#39;)))) x JOIN (SELECT appid FROM ods_dim_appkey WHERE dt=&#39;{dt}&#39; AND is_weibo=&#39;1&#39;) y ON x.oper_src_id=y.appid JOIN (SELECT dt, uid FROM mds_user_active_day_clear WHERE dt=&#39;{dt}&#39;) z ON x.uid=z.uid AND x.dt=z.dt GROUP BY x.uid 4.3.3 热门微博的点击数 SELECT dt, action, count(1) FROM ( SELECT dt, action, uid, mid FROM ( SELECT dt, &#39;点击文章&#39;AS action, uid, split(split(extend,&#39;mid:&#39;)[1],&#39;\\\\|&#39;)[0]AS mid FROM ods_wls_encode_bhv WHERE dt&gt;=&#39;20161201&#39; AND dt&lt;=&#39;20161231&#39; AND action=&#39;1423&#39; AND act=&#39;other&#39; AND (main_id LIKE &#39;102803%&#39; OR main_id LIKE &#39;230509%&#39; OR main_id LIKE &#39;231159%&#39; OR main_id LIKE &#39;231146%&#39; OR main_id LIKE &#39;231147%&#39; OR main_id LIKE &#39;230584%&#39; OR main_id LIKE &#39;230781%&#39; OR (uicode=&#39;10000225&#39; AND length(uid)&gt;10)) AND from_val LIKE &#39;10%&#39; AND (VERSION=0 OR VERSION IS NULL) UNION ALL SELECT dt, &#39;点击视频&#39;AS action, uid, split(split(extend,&#39;mid:&#39;)[1],&#39;\\\\|&#39;)[0]AS mid FROM ods_wls_encode_bhv WHERE dt&gt;=&#39;20161201&#39; AND dt&lt;=&#39;20161231&#39; AND action=&#39;799&#39; AND act=&#39;799&#39; AND (main_id LIKE &#39;102803%&#39; OR main_id LIKE &#39;230509%&#39; OR main_id LIKE &#39;231159%&#39; OR main_id LIKE &#39;231146%&#39; OR main_id LIKE &#39;231147%&#39; OR main_id LIKE &#39;230584%&#39; OR main_id LIKE &#39;230781%&#39; OR (uicode=&#39;10000225&#39; AND length(uid)&gt;10)) AND from_val LIKE &#39;10%&#39; AND (VERSION=0 OR VERSION IS NULL) AND ((from_val&gt;=&#39;1065000000&#39; AND split(split(extend,&#39;valid_play_duration:&#39;)[1],&#39;\\\\|&#39;)[0]&gt;3000) OR (from_val&lt;&#39;1065000000&#39; AND split(split(extend,&#39;playduration:&#39;)[1],&#39;\\\\|&#39;)[0]&gt;3000)) UNION ALL SELECT dt, &#39;点击图片&#39; AS action, uid, split(split(extend,&#39;mid:&#39;)[1],&#39;\\\\|&#39;)[0]AS mid FROM ods_wls_encode_bhv WHERE dt&gt;=&#39;20161201&#39; AND dt&lt;=&#39;20161231&#39; AND action IN (&#39;41&#39;,&#39;54&#39;,&#39;55&#39;,&#39;127&#39;,&#39;128&#39;,&#39;749&#39;) AND act IN (&#39;749&#39;,&#39;other&#39;) AND (split(previous_id,&#39;\\\\|&#39;)[0] like &#39;102803%&#39; or split(previous_id,&#39;\\\\|&#39;)[0] like &#39;230509%&#39;or split(previous_id,&#39;\\\\|&#39;)[0] LIKE &#39;231159%&#39; OR previous_id LIKE &#39;231146%&#39; OR previous_id LIKE &#39;231147%&#39; OR split(previous_id,&#39;\\\\|&#39;)[0] like &#39;230584%&#39; or split(previous_id,&#39;\\\\|&#39;)[0] LIKE &#39;230781%&#39; OR (previous_uicode= &#39;10000225&#39; AND length(uid)&gt;10)) AND from_val LIKE &#39;10%&#39; AND (VERSION=0 OR VERSION IS NULL) UNION ALL SELECT dt,&#39;点击正文&#39; AS action,uid,target_id AS mid FROM ods_wls_encode_bhv WHERE dt&gt;=&#39;20161201&#39; AND dt&lt;=&#39;20161231&#39; AND action=&#39;7&#39; AND act=&#39;other&#39; AND (split(previous_id,&#39;\\\\|&#39;)[0] like &#39;102803%&#39; or split(previous_id,&#39;\\\\|&#39;)[0] like &#39;230509%&#39;or split(previous_id,&#39;\\\\|&#39;)[0] LIKE &#39;231159%&#39; OR previous_id LIKE &#39;231146%&#39; OR previous_id LIKE &#39;231147%&#39; OR split(previous_id,&#39;\\\\|&#39;)[0] like &#39;230584%&#39; or split(previous_id,&#39;\\\\|&#39;)[0] LIKE &#39;230781%&#39; OR (previous_uicode= &#39;10000225&#39; AND length(uid)&gt;10)) AND from_val LIKE &#39;10%&#39; AND (VERSION=0 OR VERSION IS NULL))a GROUP BY dt, action, uid, mid)x GROUP BY dt, action 4.4 首次打开按luicode SELECT KEY, count(uid) AS cnt FROM (SELECT uid, split(day_key,&#39;\\\\\\\\|&#39;)[1] as key,row_number() over (PARTITION BY uid ORDER BY split(day_key,&#39;\\\\\\\\|&#39;)[1] ASC) AS rn FROM ods_wls_encode_bhv WHERE dt BETWEEN &#39;20171210&#39; AND &#39;20171211&#39; AND act=&#39;496&#39; AND split(day_key, &#39;\\\\\\\\|&#39;)[1] BETWEEN &#39;2017-12-10 06:00:00&#39; AND &#39;2017-12-11 05:59:59&#39; AND act=&#39;496&#39; AND uid IS NOT NULL AND wm NOT IN (&#39;8605_2003&#39;, &#39;4209_8001&#39;, &#39;90027_90052&#39;) )a WHERE rn = 1 GROUP BY KEY ORDER BY cnt DESC 4.5 在线时长 SELECT t2.actv_freq, avg(t3.time) FROM (SELECT uid FROM tmp_weibo_usergrowth_zz_uid WHERE dt = &#39;20171210&#39;) t1 LEFT JOIN (SELECT uid, actv_freq FROM mds_bhv_user_active_month_stat WHERE dt = &#39;20171211&#39; AND stat_type = &#39;2&#39; GROUP BY uid, actv_freq) t2 ON t1.uid = t2.uid LEFT JOIN ( SELECT uid, sum(time) AS time FROM ( SELECT t3.uid, split(split(t3.extend, &#39;useTime:&#39;)[1], &#39;\\\\\\\\|&#39;)[0] AS time FROM (SELECT uid, extend FROM ods_wls_encode_bhv WHERE dt = &#39;20171210&#39; AND act = &#39;1339&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) AND length(uid) &lt;= 13 GROUP BY uid, extend) t3 WHERE split(split(t3.extend, &#39;useTime:&#39;)[1], &#39;\\\\\\\\|&#39;)[0] BETWEEN &#39;0&#39; AND &#39;10800&#39;) a GROUP BY uid) t3 ON t1.uid = t3.uid GROUP BY t2.actv_freq 4.6 可push库地理位置 insert overwrite local directory &#39;/data0/weibo_usergrowth/zouqi/scripts/temp/zb&#39; SELECT count(a.uid) FROM (SELECT uid FROM mds_wls_oper_pushable_devicelist WHERE dt=20171210 GROUP BY uid) a INNER JOIN (SELECT uid FROM mds_bas_user_usagefreq WHERE dt=20171210 AND use_in_mb=&#39;2&#39;)b ON a.uid=b.uid INNER JOIN (SELECT uid FROM (SELECT uid, IF(substring(city_location,1,7) = substring(district_location,1,7), district_location, city_location) AS district FROM tmp_leon_uid_city_district WHERE dt=20171212) a WHERE substring(district,6,2) NOT IN (&#39;11&#39;, &#39;31&#39;) AND substring(district,6,4) NOT IN (&#39;4401&#39;, &#39;4403&#39;)) c ON a.uid=c.uid GROUP BY a.uid ORDER BY a.uid 4.7 用户类型 SELECT f.uid AS uid, f.gp AS label FROM (SELECT CASE WHEN d.uid IS NOT NULL THEN &#39;新户正式用户&#39; ELSE &#39;召回正式用户&#39; END AS gp, c.uid FROM (SELECT a.uid FROM (SELECT uid FROM mds_bhv_login_day WHERE dt=&#39;${dt[$i]}&#39; AND login_type=&#39;wap_client&#39; AND length(uid)&lt;=10 GROUP BY uid)a LEFT OUTER JOIN (SELECT uid FROM mds_bhv_user_active_month_stat WHERE dt=&#39;${dt_1}&#39; AND length(uid)&lt;=10 AND stat_type=&#39;2&#39;)b ON a.uid=b.uid WHERE b.uid IS NULL)c LEFT OUTER JOIN (SELECT uid FROM mds_user_reg_info WHERE dt=&#39;${dt[$i]}&#39; GROUP BY uid)d ON c.uid=d.uid UNION ALL SELECT CASE WHEN d1.uid IS NOT NULL THEN &#39;新户访客&#39; ELSE &#39;召回访客&#39; END AS gp, c1.uid FROM (SELECT a1.uid FROM (SELECT w1.guest_id AS uid FROM (SELECT guest_id FROM ods_wls_guest_login WHERE dt=&#39;${dt[$i]}&#39; AND wfrom LIKE &#39;10%&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) GROUP BY guest_id)w1 LEFT OUTER JOIN (SELECT guest_id FROM ods_wls_guest_login WHERE dt=&#39;${dt[$i]}&#39; AND wfrom LIKE &#39;10%&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) AND MODE=&#39;TRANS&#39; GROUP BY guest_id)j1 ON w1.guest_id=j1.guest_id WHERE j1.guest_id IS NULL)a1 LEFT OUTER JOIN (SELECT guest_id AS uid FROM ods_wls_guest_login WHERE dt&gt;=&#39;${dt_30}&#39; AND dt&lt;=&#39;${dt_1}&#39; AND wfrom LIKE &#39;10%&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) GROUP BY guest_id)b1 ON a1.uid=b1.uid WHERE b1.uid IS NULL)c1 LEFT OUTER JOIN (SELECT guest_id AS uid FROM ods_wls_guest_login WHERE dt=&#39;${dt[$i]}&#39; AND wfrom LIKE &#39;10%&#39; AND ((wm&lt;&gt;&#39;8605_2003&#39; AND wm&lt;&gt;&#39;4209_8001&#39; AND wm&lt;&gt;&#39;90027_90052&#39;) OR wm IS NULL) AND MODE=&#39;REGISTER&#39; GROUP BY guest_id)d1 ON c1.uid=d1.uid)f GROUP BY f.gp, f.uid; 4.8 发博转发评论中位数 SELECT t2.actv_freq, avg(orig_cnt), avg(tran_cnt), avg(cmt_cnt), avg(new_atten_cnt), percentile(cast(orig_cnt as BIGINT), 0.5), percentile(cast(tran_cnt as BIGINT), 0.5), percentile(cast(cmt_cnt as BIGINT), 0.5), percentile(cast(new_atten_cnt as BIGINT), 0.5) FROM (SELECT uid FROM tmp_weibo_usergrowth_zz_uid WHERE dt = &#39;20171210&#39;) t1 LEFT JOIN (SELECT uid, actv_freq FROM mds_bhv_user_active_month_stat WHERE dt = &#39;20171211&#39; AND mobile_actv_days &gt; 0 AND stat_type = &#39;2&#39; GROUP BY uid, actv_freq) t2 ON t1.uid = t2.uid LEFT JOIN (SELECT uid, orig_cnt, tran_cnt, cmt_cnt+reply_cmt_cnt as cmt_cnt, new_atten_cnt FROM mds_bhv_tblog_day WHERE dt=&#39;20171210&#39; AND app_class_code = &#39;2&#39; AND is_weibo = &#39;10000&#39; GROUP BY uid, orig_cnt, tran_cnt, cmt_cnt+reply_cmt_cnt, new_atten_cnt) t3 ON t1.uid = t3.uid GROUP BY t2.actv_freq 4.9 主要行为 SELECT uid FROM mds_bhv_user_active_month_30days WHERE dt = &#39;20180104&#39; AND mobile_actv_days &gt; 0 AND actv_freq = &#39;9&#39; ---热门流 SELECT uid FROM ods_tblog_expo WHERE dt = &#39;20180104&#39; AND appid=6 AND interface_id in(800,900) AND split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] in(&#39;102803&#39;,&#39;230509&#39;,&#39;231159&#39;) --关注流和分享 SELECT uid, count(CASE WHEN action IN (&#39;1246&#39;, &#39;97&#39;) THEN uid ELSE NULL END) AS &#39;attenfeed&#39;, count(CASE WHEN action IN (&#39;37&#39;, &#39;38&#39;, &#39;298&#39;, &#39;299&#39;, &#39;370&#39;, &#39;371&#39;, &#39;700&#39;, &#39;682&#39;) THEN uid ELSE NULL END) AS &#39;share&#39; FROM ods_wls_encode_bhv WHERE dt=&#39;20180104&#39; AND act=&#39;other&#39; AND uid IS NOT NULL GROUP BY uid --评论，发博，转发 SELECT uid, cmt_cnt+reply_cmt_cnt AS cmt_cnt, orig_cnt, tran_cnt FROM mds_bhv_tblog_day WHERE dt = &#39;20180104&#39; --主动关注 SELECT uid FROM mds_bhv_addatten where dt = &#39;20180104&#39; AND mode=&#39;12&#39; and object_cnt=1 ---点赞 SELECT uid FROM mds_bhv_like WHERE dt= &#39;20180104&#39; AND MODE=1 4.10 曝光 -------访客用户DAU select count(distinct a.uid), count(distinct case when is_weibo =1 and app_class_code=2 and interface_id in (1,5,8) then a.uid end ) as zhu, count(distinct case when is_weibo =1 and app_class_code=2 and interface_id in (2,3,6,202,207,201,203) then a.uid end ) as fen, count(distinct case when is_weibo=1 and app_class_code=2 and interface_id=50 then a.uid end ) ta, count(distinct case when appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] =100808 then a.uid end ) hua, count(distinct case when appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] in(102803,230509,231159) then a.uid end ) re, count(distinct case when appid =6 and interface_id in(900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] in(&#39;100103&#39;,&#39;100303&#39;,&#39;230926&#39;,&#39;230909&#39;,&#39;230928&#39;) then a.uid end ) as sou, count(distinct case when appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] not in(&#39;102803&#39; ,&#39;230509&#39;,&#39;100808&#39;,&#39;100103&#39;,&#39;100303&#39;,&#39;230616&#39;,&#39;230618&#39;,&#39;230283&#39;,&#39;231002&#39;,&#39;230969&#39; ,&#39;230408&#39;,&#39;230869&#39;,&#39;230926&#39;,&#39;230909&#39;,&#39;230928&#39;) then a.uid end ) as qita, count(distinct case when (is_weibo =1 and app_class_code=2 and interface_id in (1,5,8)) or (is_weibo =1 and app_class_code=2 and interface_id in (2,3,6,202,207,201,203) ) or (is_weibo=1 and app_class_code=2 and interface_id=50 ) or (appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] =100808 ) or(appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] in(102803,230509,231159) ) or (appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] in(102803,230509,231159) ) or (appid =6 and interface_id in(800,900) and split(split(extend2,&#39;containerid=&gt;&#39;)[1],&#39;,&#39;)[0] not in(&#39;102803&#39; ,&#39;230509&#39;,&#39;100808&#39;,&#39;100103&#39;,&#39;100303&#39;,&#39;230616&#39;,&#39;230618&#39;,&#39;230283&#39;,&#39;231002&#39;,&#39;230969&#39; ,&#39;230408&#39;,&#39;230869&#39;,&#39;230926&#39;,&#39;230909&#39;,&#39;230928&#39;)) then a.uid end) as all from ( select a1.uid from (select guest_id as uid from ods_wls_guest_login where dt = &#39;20171029&#39; and MODE in (&#39;REGISTER&#39;) and mode not in (&#39;TRANS&#39;) and wm not in (&#39;8605_2003&#39;,&#39;4209_8001&#39;,&#39;90027_90052&#39;) and wfrom like &#39;10%&#39; )a1 left outer join (select guest_id as uid from ods_wls_guest_login where dt = &#39;20171029&#39; and mode in (&#39;TRANS&#39;) and wm not in (&#39;8605_2003&#39;,&#39;4209_8001&#39;,&#39;90027_90052&#39;) and wfrom like &#39;10%&#39; )b1 on a1.uid = b1.uid where b1.uid is null )a left outer join (select uid,appid,interface_id,extend2 from ods_tblog_expo where dt = &#39;20171029&#39; )b on a.uid = b.uid left outer join (select appid as apid,is_weibo,app_class_code from ods_dim_appkey where dt = &#39;20171029&#39; )c on b.appid = c.apid 4.11 点赞分享中位数 SELECT t2.actv_freq, avg(like_cnt), avg(SHARE), percentile(cast(like_cnt as BIGINT), 0.5), percentile(cast(SHARE as BIGINT), 0.5) FROM (SELECT uid FROM tmp_weibo_usergrowth_zz_uid WHERE dt = &#39;20171210&#39;) t1 LEFT JOIN (SELECT uid, actv_freq FROM mds_bhv_user_active_month_stat WHERE dt = &#39;20171211&#39; AND mobile_actv_days &gt; 0 AND stat_type = &#39;2&#39; GROUP BY uid, actv_freq) t2 ON t1.uid = t2.uid LEFT JOIN (SELECT uid, count(*) like_cnt FROM mds_bhv_like WHERE dt=&#39;20171210&#39; AND MODE=1 GROUP BY uid) t3 ON t1.uid = t3.uid LEFT JOIN (SELECT uid, count(*) AS SHARE FROM ods_wls_encode_bhv WHERE dt=&#39;20171210&#39; AND act=&#39;other&#39; AND action IN (&#39;37&#39;, &#39;38&#39;, &#39;298&#39;, &#39;299&#39;, &#39;370&#39;, &#39;371&#39;, &#39;700&#39;, &#39;682&#39;) GROUP BY uid) t4 ON t1.uid = t4.uid GROUP BY t2.actv_freq "],
["applications.html", "Chapter 5 Applications 5.1 Example one 5.2 Example two", " Chapter 5 Applications Some significant applications are demonstrated in this chapter. 5.1 Example one 5.2 Example two "],
["final-words.html", "Chapter 6 Final Words", " Chapter 6 Final Words We have finished a nice book. "],
["references.html", "References", " References "]
]
